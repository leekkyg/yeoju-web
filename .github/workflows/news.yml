name: 여주 뉴스 수집

on:
  schedule:
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: 뉴스 수집
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          node << 'EOF'
          const https = require('https');
          
          const url = 'https://news.google.com/rss/search?q=여주시&hl=ko&gl=KR&ceid=KR:ko';
          
          https.get(url, (res) => {
            let data = '';
            res.on('data', chunk => data += chunk);
            res.on('end', () => {
              const titleRegex = /<title><!\[CDATA\[(.*?)\]\]><\/title>/g;
              const linkRegex = /<link>(https:\/\/news\.google\.com\/[^<]+)<\/link>/g;
              
              const titles = [];
              const links = [];
              let match;
              
              while ((match = titleRegex.exec(data)) !== null) {
                titles.push(match[1]);
              }
              while ((match = linkRegex.exec(data)) !== null) {
                links.push(match[1]);
              }
              
              const supabaseHost = process.env.SUPABASE_URL.replace('https://', '');
              
              for (let i = 1; i < Math.min(titles.length, 11); i++) {
                const title = titles[i].replace(/"/g, '\\"').replace(/'/g, '');
                const link = links[i] || '';
                
                console.log('저장:', title);
                
                const postData = JSON.stringify({
                  title: title,
                  source: '구글뉴스',
                  link: link
                });
                
                const req = https.request({
                  hostname: supabaseHost,
                  path: '/rest/v1/news',
                  method: 'POST',
                  headers: {
                    'apikey': process.env.SUPABASE_KEY,
                    'Authorization': 'Bearer ' + process.env.SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'resolution=ignore-duplicates'
                  }
                });
                req.write(postData);
                req.end();
              }
              
              console.log('완료!');
            });
          });
          EOF