name: 여주 뉴스 수집

on:
  schedule:
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: 뉴스 수집
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "=== 경기일보 수집 ==="
          curl -s "https://www.kyeonggi.com/rss/S1N14.xml" -A "Mozilla/5.0" -o rss.xml
          
          grep -oP '(?<=<title><!\[CDATA\[)[^]]+' rss.xml | head -10 > titles.txt || true
          grep -oP '(?<=<link>)https://www.kyeonggi.com[^<]+' rss.xml | head -10 > links.txt || true
          
          echo "제목들:"
          cat titles.txt
          
          echo "링크들:"
          cat links.txt
          
          while IFS= read -r title && IFS= read -r link <&3; do
            if [ -n "$title" ] && [ -n "$link" ]; then
              echo "저장: $title"
              title=$(echo "$title" | sed 's/"/\\"/g')
              curl -s -X POST "${SUPABASE_URL}/rest/v1/news" \
                -H "apikey: ${SUPABASE_KEY}" \
                -H "Authorization: Bearer ${SUPABASE_KEY}" \
                -H "Content-Type: application/json" \
                -H "Prefer: resolution=ignore-duplicates" \
                -d "{\"title\": \"${title}\", \"source\": \"경기일보\", \"link\": \"${link}\"}"
            fi
          done < titles.txt 3< links.txt
          
          echo "=== 완료 ==="