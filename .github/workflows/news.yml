name: 여주 뉴스 수집

on:
  schedule:
    - cron: '0 0,6,12,18 * * *'  # 매일 4번 (0시, 6시, 12시, 18시)
  workflow_dispatch:  # 수동 실행

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: 뉴스 수집 및 저장
        uses: actions/github-script@v7
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        with:
          script: |
            const fetch = require('node-fetch');
            
            // 네이버 뉴스 검색 (여주)
            const searchUrl = 'https://search.naver.com/search.naver?where=news&query=여주시&sort=1';
            
            const response = await fetch(searchUrl, {
              headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
              }
            });
            const html = await response.text();
            
            // 뉴스 파싱
            const newsRegex = /<a href="(https:\/\/n\.news\.naver\.com[^"]+)"[^>]*class="news_tit"[^>]*title="([^"]+)"/g;
            const sourceRegex = /<a[^>]*class="info press"[^>]*>([^<]+)<\/a>/g;
            
            const news = [];
            let match;
            
            while ((match = newsRegex.exec(html)) !== null) {
              news.push({
                link: match[1],
                title: match[2]
              });
            }
            
            // Supabase에 저장
            const supabaseUrl = process.env.SUPABASE_URL;
            const supabaseKey = process.env.SUPABASE_KEY;
            
            for (const item of news.slice(0, 10)) {
              await fetch(`${supabaseUrl}/rest/v1/news`, {
                method: 'POST',
                headers: {
                  'apikey': supabaseKey,
                  'Authorization': `Bearer ${supabaseKey}`,
                  'Content-Type': 'application/json',
                  'Prefer': 'resolution=ignore-duplicates'
                },
                body: JSON.stringify({
                  title: item.title,
                  source: '네이버뉴스',
                  link: item.link,
                  published_at: new Date().toISOString()
                })
              });
            }
            
            console.log(`${news.length}개 뉴스 수집 완료`);