name: 여주 뉴스 수집

on:
  schedule:
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:

jobs:
  collect-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: 뉴스 수집 및 저장
        run: |
          # 네이버 뉴스 검색
          NEWS=$(curl -s "https://search.naver.com/search.naver?where=news&query=%EC%97%AC%EC%A3%BC%EC%8B%9C&sort=1" \
            -H "User-Agent: Mozilla/5.0")
          
          # 뉴스 제목과 링크 추출 후 Supabase에 저장
          echo "$NEWS" | grep -oP 'href="(https://n\.news\.naver\.com[^"]+)"[^>]*class="news_tit"[^>]*title="([^"]+)"' | head -10 | while read line; do
            LINK=$(echo "$line" | grep -oP 'https://n\.news\.naver\.com[^"]+')
            TITLE=$(echo "$line" | grep -oP 'title="[^"]+"' | sed 's/title="//;s/"$//')
            
            if [ -n "$LINK" ] && [ -n "$TITLE" ]; then
              curl -X POST "${{ secrets.SUPABASE_URL }}/rest/v1/news" \
                -H "apikey: ${{ secrets.SUPABASE_KEY }}" \
                -H "Authorization: Bearer ${{ secrets.SUPABASE_KEY }}" \
                -H "Content-Type: application/json" \
                -H "Prefer: resolution=ignore-duplicates" \
                -d "{\"title\": \"$TITLE\", \"source\": \"네이버뉴스\", \"link\": \"$LINK\"}"
            fi
          done
          
          echo "뉴스 수집 완료"